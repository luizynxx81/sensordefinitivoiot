<main class="min-h-screen bg-gray-900 text-white p-4 sm:p-6 lg:p-8">
  <div class="max-w-7xl mx-auto">
    <header class="mb-8 flex justify-between items-center">
      <div>
        <h1 class="text-3xl font-bold text-gray-100">IoT Distance Monitor</h1>
        <p class="text-gray-400">Real-time data from proximity sensor.</p>
      </div>
      <div class="flex items-center space-x-2">
        <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
        <span class="text-green-400 font-medium">LIVE</span>
      </div>
    </header>

    @if (isLoading()) {
      <div class="flex justify-center items-center h-64">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-blue-500"></div>
      </div>
    } @else if (error()) {
      <div class="bg-red-900 border border-red-700 text-red-200 px-4 py-3 rounded relative" role="alert">
        <strong class="font-bold">Error:</strong>
        <span class="block sm:inline">{{ error() }}</span>
      </div>
    } @else {
      @if (latestMeasurement(); as latest) {
        @let latestStatus = getDistanceStatus(latest.datos_sensor.distancia_cm);
        <section id="latest-reading" class="mb-10">
          <div [class]="latestStatus.cardClass + ' rounded-xl shadow-2xl p-6 sm:p-8 transition-colors duration-500 ease-in-out'">
            <h2 class="text-lg font-semibold text-gray-200 mb-2">LATEST MEASUREMENT</h2>
            <div class="flex items-baseline justify-center text-center">
              <span class="text-7xl sm:text-8xl lg:text-9xl font-extrabold tracking-tighter">{{ latest.datos_sensor.distancia_cm }}</span>
              <span class="text-2xl sm:text-3xl font-medium text-gray-300 ml-2">cm</span>
            </div>
            <p class="text-center text-gray-300 mt-2">from device: <span class="font-mono bg-gray-800/50 px-2 py-1 rounded">{{ latest.device_id }}</span></p>
            
            @if (latestStatus.level === 'alert') {
              <div class="mt-6 text-center bg-red-800/70 border border-red-600 rounded-lg p-3">
                <p class="font-bold text-lg text-red-100 animate-pulse">! ! ! DANGER ALERT ! ! !</p>
              </div>
            } @else if (latestStatus.level === 'warning') {
              <div class="mt-6 text-center bg-yellow-800/70 border border-yellow-600 rounded-lg p-3">
                <p class="font-bold text-lg text-yellow-100">! ! WARNING ! !</p>
              </div>
            } @else if (latestStatus.level === 'observe') {
              <div class="mt-6 text-center bg-blue-800/70 border border-blue-600 rounded-lg p-3">
                <p class="font-bold text-lg text-blue-100">OBSERVE</p>
              </div>
            }
          </div>
        </section>
      } @else {
        <section class="mb-10 bg-gray-800 rounded-xl p-8 text-center">
            <h2 class="text-2xl font-bold text-gray-300">No Data Available</h2>
            <p class="text-gray-500 mt-2">Waiting for the first measurement from the device...</p>
        </section>
      }

      <!-- New Chart Section -->
      <section id="chart" class="mb-10">
        <h2 class="text-2xl font-bold mb-4 text-gray-200">Distance History Chart</h2>
        <div class="bg-gray-800 rounded-lg shadow-lg p-4">
          @if (measurements().length > 1) {
            <app-chart [data]="measurements()"></app-chart>
          } @else {
            <div class="flex items-center justify-center w-full h-[300px] bg-gray-800 rounded-lg border-2 border-dashed border-gray-700 text-gray-500">
              <p>Not enough data to display chart. At least 2 measurements are required.</p>
            </div>
          }
        </div>
      </section>

      <section id="history">
        <h2 class="text-2xl font-bold mb-4 text-gray-200">Measurement History (Last 10)</h2>
        <div class="overflow-x-auto bg-gray-800 rounded-lg shadow-lg">
          <table class="min-w-full text-sm text-left text-gray-300">
            <thead class="text-xs text-gray-400 uppercase bg-gray-700/50">
              <tr>
                <th scope="col" class="px-6 py-3">Timestamp</th>
                <th scope="col" class="px-6 py-3">Device ID</th>
                <th scope="col" class="px-6 py-3 text-right">Distance (cm)</th>
                <th scope="col" class="px-6 py-3 text-center">Status</th>
              </tr>
            </thead>
            <tbody>
              @for (measurement of measurements().slice(0, 10); track measurement.id) {
                @let mStatus = getDistanceStatus(measurement.datos_sensor.distancia_cm);
                <tr class="border-b border-gray-700 hover:bg-gray-700/50 transition-colors duration-150">
                  <td class="px-6 py-4 font-medium">{{ formatTimestamp(measurement.created_at) }}</td>
                  <td class="px-6 py-4 font-mono">{{ measurement.device_id }}</td>
                  <td class="px-6 py-4 text-right font-bold text-lg">{{ measurement.datos_sensor.distancia_cm }}</td>
                  <td class="px-6 py-4 text-center">
                    <span [class]="mStatus.textColorClass + ' px-3 py-1 text-xs font-semibold rounded-full ' + mStatus.pillClass">
                      {{ mStatus.text }}
                    </span>
                  </td>
                </tr>
              }
              @if (measurements().length === 0 && !isLoading()) {
                <tr>
                    <td colspan="4" class="text-center py-8 text-gray-500">No historical data to display.</td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </section>
    }
  </div>
</main>